<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>IFRC Health Facility Exposure (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link   href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <!-- Turf for spatial math -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <style>
    html, body { margin: 0; height: 100%; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #panel{position:absolute;top:10px;left:10px;z-index:2;
      background:rgba(255,255,255,.97);padding:12px;width:380px;
      font-family:system-ui,Arial,sans-serif;font-size:13px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);max-height:calc(100% - 20px);overflow:auto}
    h1{font-size:16px;margin:0 0 6px}
    .legend{font-size:12px;margin:6px 0 8px}
    .legend span{display:inline-block;width:10px;height:10px;margin-right:4px;vertical-align:middle}
    .lg-eq{background:#e36a6a}.lg-gdacs{background:#f4a742}.lg-fac{background:#3b82f6}
    .row{margin:8px 0}
    label{font-weight:600;display:block;margin-bottom:4px}
    select,input[type=number]{width:100%;padding:6px;border:1px solid #ccc;border-radius:4px}
    .toggles{display:flex;gap:10px;flex-wrap:wrap}
    .toggle{display:flex;align-items:center;gap:6px;margin:3px 0}
    .hr{height:1px;background:#eee;margin:10px 0}
    #summary{padding:8px;background:#f6f7f9;border-radius:6px}
    #list{margin-top:8px;max-height:220px;overflow:auto;border:1px solid #eee;border-radius:6px}
    .item{padding:8px;border-bottom:1px solid #eee;cursor:pointer}
    .item:last-child{border-bottom:none}
    .muted{color:#666}
    .badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:6px}
    .status-functional{background:#e7f6ec;color:#1b7f3a}
    .status-partial{background:#fff7e6;color:#ad5a00}
    .status-nonfunctional{background:#fdecec;color:#9a1f1f}
    .status-unknown{background:#eef2f7;color:#374151}
    .kv{margin:3px 0}.kv b{display:inline-block;min-width:150px}
    .section{margin-top:10px}
    .section h3{font-size:13px;margin:8px 0 4px;border-bottom:1px solid #eee;padding-bottom:3px}
    .small{font-size:12px}
    .pill{display:inline-block;border-radius:9999px;padding:2px 8px;margin:2px;font-size:11px}
    .btn{background:#2563eb;color:#fff;border:none;border-radius:4px;padding:6px 8px;cursor:pointer}
  </style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h1>IFRC Health Facility Exposure (MVP)</h1>
  <div class="legend">
    <span class="lg-eq"></span>USGS Earthquakes
    <span class="lg-gdacs" style="margin-left:10px"></span>GDACS (beta)
    <span class="lg-fac" style="margin-left:10px"></span>IFRC Facilities
  </div>

  <div class="row">
    <label>Filters</label>
    <select id="countryFilter"><option value="">All countries</option></select>
    <div style="height:6px"></div>
    <!-- Keep only "All types"; JS fills the rest dynamically -->
    <select id="typeFilter"><option value="">All types</option></select>
    <div style="height:6px"></div>
    <select id="statusFilter">
      <option value="">All status</option>
      <option>functional</option><option>partial</option><option>nonfunctional</option><option>unknown</option>
    </select>
    <div style="height:6px"></div>
    <input id="bedsMin" type="number" min="0" placeholder="Min total beds (optional)">
  </div>

  <div class="row toggles">
    <div class="toggle"><input type="checkbox" id="terrainToggle" checked><label>Terrain</label></div>
    <div class="toggle"><input type="checkbox" id="facToggle" checked><label>Facilities</label></div>
    <div class="toggle"><input type="checkbox" id="usgsToggle" checked><label>USGS EQ</label></div>
    <div class="toggle"><input type="checkbox" id="gdacsToggle" checked><label>GDACS</label></div>
    <div class="toggle"><input type="checkbox" id="roadsToggle" checked><label>Roads</label></div>
    <div class="toggle"><input type="checkbox" id="popToggle" checked><label>Population</label></div>
    <div class="toggle"><input type="checkbox" id="satToggle"><label>Satellite Imagery</label></div>
  </div>

  <div class="hr"></div>

  <div id="summary" class="small">Tip: click a facility for details or an earthquake for exposure.</div>
  <div id="list"></div>
  <div id="details" class="section"></div>
</div>

<script>
mapboxgl.accessToken='pk.eyJ1Ijoic2FtaWtzaGFnYWhlcndhciIsImEiOiJjbWVnOHVjamcxNHFwMm5xNHJscHdxYjdqIn0.x2xdpJyWndbT007njbAKEA';

const GO_BASE = 'https://goadmin.ifrc.org/api/v2';
const GO_TOKEN = 'a0aefae0c20a1372e1cf058b7b3df53c87cffabc'; // <-- replace

const USGS='https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_day.geojson';
const GDACS='https://corsproxy.io/?https://www.gdacs.org/gdacsapi/api/events/geteventlist/';  // simple proxy

let facAll={type:'FeatureCollection',features:[]}, facFiltered={type:'FeatureCollection',features:[]};
let usgsFC=null, gdacsFC=null, hazFeature=null, hazBuffer=null;

const map=new mapboxgl.Map({container:'map',style:'mapbox://styles/mapbox/light-v11',center:[20,10],zoom:2});

const q=(id)=>document.getElementById(id);
const fmt=(v)=>v||v===0?v:'—';
const n=(v)=>Number(v);
const t=(v)=>v===true || String(v).toLowerCase()==='true';
const badge=(s)=>`<span class="badge status-${s||'unknown'}">${s||'unknown'}</span>`;
const magToKm=(m)=>Math.max(10,Math.min(Math.round(Math.pow(10,0.5*m-1.2)),250));
const distKm=(a,b)=>turf.distance(a,b,{units:'kilometers'});

/* ---------------- IFRC helpers ---------------- */
async function fetchAllIFRC(url) {
  const headers = { Authorization: `Token ${GO_TOKEN}`, Accept: 'application/json' };
  let out = [], next = url;
  while (next) {
    const r = await fetch(next, { headers });
    if (!r.ok) throw new Error(`IFRC API ${r.status}: ${next}`);
    const j = await r.json();
    out = out.concat(j.results || (Array.isArray(j) ? j : []));
    next = j.next || null;
  }
  return out;
}

// Map a list item → minimal feature; health details are added on click.
function mapLocalUnitToFeature(r) {
  let lon = null, lat = null;
  const lg = r.location_geojson;
  if (lg?.type === 'Point' && Array.isArray(lg.coordinates)) {
    [lon, lat] = lg.coordinates;
  }
  if (lon == null || lat == null) return null;

  const unitTypeName = r.type_details?.name || null; // Administrative, Health Care, etc.
  const healthTypeName = r.health_details?.health_facility_type_details?.name || null; // Blood Center, Hospital ...

  const p = {
    lat: lat,
    lon: lon,
    id: r.id,
    name: r.english_branch_name || r.local_branch_name || 'Local Unit',
    facility_name: r.english_branch_name || r.local_branch_name || 'Local Unit',
    country: r.country_details?.name || null,
    iso3: r.country_details?.iso3 || null,

    type_name: unitTypeName,
    type: (unitTypeName || '').toLowerCase().replace(/\s+/g,'_'),
    health_facility_type: healthTypeName || null,

    address: r.address_en || r.address_loc || null,
    contact: r.email || r.phone || r.focal_person_en || r.focal_person_loc || null,
    last_updated: r.modified_at || null,
    confidence: r.validated ? 'validated' : (r.draft ? 'draft' : null),

    status: 'unknown',
    beds_total: null,
    inpatient_capable: false,
    warehousing: false,
    cold_chain: false,

    // HR placeholders
    hr_total: null,
    hr_gp: null,
    hr_specialist: null,
    hr_residents: null,
    hr_nurse: null,
    hr_dentist: null,
    hr_nursing_aid: null,
    hr_midwife: null,

    // Service flags
    svc_emergency: false,
    svc_maternity: false,
    svc_surgery: false,
    svc_ncd: false,
    svc_mhpss: false,
    svc_lab: false,
    svc_radiology: false,
    svc_vaccination: false,
    svc_pharmacy: false,
    svc_isolation_id: false,

    _enriched: false
  };

  return { type: 'Feature', geometry: { type: 'Point', coordinates: [lon, lat] }, properties: p };
}

async function fetchIFRCDetail(id) {
  const url = `${GO_BASE}/local-units/${id}/`;
  const headers = { Authorization: `Token ${GO_TOKEN}`, Accept: 'application/json' };
  const r = await fetch(url, { headers });
  if (!r.ok) throw new Error(`IFRC detail ${r.status}: ${url}`);
  return r.json();
}

function enrichFeatureFromDetail(f, d) {
  const p = f.properties;

  // functionality -> status
  const funcName = (d.health?.functionality_details?.name || '').toLowerCase();
  let status = 'unknown';
  if (funcName.includes('fully')) status = 'functional';
  else if (funcName.includes('partial')) status = 'partial';
  else if (funcName.includes('not') || funcName.includes('non')) status = 'nonfunctional';

  const namesFrom = (arr) => Array.isArray(arr) ? arr.map(x => (x?.name || '').toLowerCase()) : [];
  const svcNames = new Set([
    ...namesFrom(d.health?.general_medical_services_details),
    ...namesFrom(d.health?.specialized_medical_beyond_primary_level_details),
    ...namesFrom(d.health?.blood_services_details),
    ...namesFrom(d.health?.professional_training_facilities_details)
  ]);
  const has = (kw) => [...svcNames].some(n => n.includes(kw));

  // Update labels if present
  p.facility_name = d.english_branch_name || d.local_branch_name || p.facility_name;
  p.health_facility_type = d.health?.health_facility_type_details?.name || p.health_facility_type;
  p.type_name = d.type_details?.name || p.type_name;

  // Capacity/logistics/HR
  p.status = status;
  p.beds_total = typeof d.health?.maximum_capacity === 'number' ? d.health.maximum_capacity : null;
  p.inpatient_capable = !!d.health?.is_in_patient_capacity;
  p.warehousing = !!d.health?.is_warehousing;
  p.cold_chain = !!d.health?.is_cold_chain;
  p.isolation_rooms = d.health?.number_of_isolation_rooms ?? null;
  p.hospital_type = d.health?.hospital_type_details?.name || null;
  p.teaching_hospital = !!d.health?.is_teaching_hospital;

  p.hr_total = d.health?.total_number_of_human_resource ?? null;
  p.hr_gp = d.health?.general_practitioner ?? null;
  p.hr_specialist = d.health?.specialist ?? null;
  p.hr_residents = d.health?.residents_doctor ?? null;
  p.hr_nurse = d.health?.nurse ?? null;
  p.hr_dentist = d.health?.dentist ?? null;
  p.hr_nursing_aid = d.health?.nursing_aid ?? null;
  p.hr_midwife = d.health?.midwife ?? null;

  // Service flags for pills
  p.svc_emergency = has('emergency') || has('pre hospital');
  p.svc_maternity = has('maternity') || has('gynaecology') || has('obstetric') || has('srh');
  p.svc_surgery = has('surgical') || has('surgery') || has('anaesthes');
  p.svc_ncd = has('non-communicable') || has('ncd') || has('chronic');
  p.svc_mhpss = has('mental');
  p.svc_lab = has('laboratory') || has('lab');
  p.svc_radiology = has('radiology') || has('imaging') || has('x-ray');
  p.svc_vaccination = has('vaccin');
  p.svc_pharmacy = has('pharmacy');
  p.svc_isolation_id = !!d.health?.is_isolation_rooms_wards || has('isolation');

  // Contact/meta
  p.contact = d.email || d.phone || d.focal_person_en || d.focal_person_loc || p.contact;
  p.last_updated = d.modified_at || d.created_at || p.last_updated;

  p._enriched = true;
}

/* ---------------- Load facilities ---------------- */
async function loadFacilities() {
  try {
    // You can add type__code:'2' to fetch Health Care only
    const params = new URLSearchParams({ validated: 'true', draft: 'false', limit: '500' });
    const url = `${GO_BASE}/local-units/?${params.toString()}`;
    const rows = await fetchAllIFRC(url);
    const feats = rows.map(mapLocalUnitToFeature).filter(Boolean);
    facAll = { type: 'FeatureCollection', features: feats };

    populateCountryFilter();
    populateTypeFilterFromData();
    applyFilters();
    addFacilityLayer();
  } catch (e) {
    console.error(e);
    q('summary').textContent = 'Failed to load IFRC GO Local Units';
  }
}

function populateCountryFilter(){
  const set=new Set(facAll.features.map(f=>f.properties.country).filter(Boolean));
  q('countryFilter').innerHTML='<option value="">All countries</option>'+
    [...set].sort().map(c=>`<option>${c}</option>`).join('');
}

function populateTypeFilterFromData(){
  const sel = q('typeFilter'); if (!sel) return;
  const set = new Set(facAll.features.map(f => f.properties.type_name).filter(Boolean));
  sel.innerHTML = '<option value="">All types</option>' + [...set].sort().map(t => `<option>${t}</option>`).join('');
}

function applyFilters(){
  const c = q('countryFilter').value;
  const tSel = q('typeFilter').value;
  const s = q('statusFilter').value;
  const bmin = Number(q('bedsMin').value) || 0;

  facFiltered.features = facAll.features.filter(f=>{
    const p = f.properties;
    const typeOk = !tSel || p.type_name === tSel || p.type === tSel.toLowerCase().replace(/\s+/g,'_');
    const statusOk = !s || p.status === s;
    const bedsOk = !bmin || (p.beds_total || 0) >= bmin;
    const countryOk = !c || p.country === c;
    return typeOk && statusOk && bedsOk && countryOk;
  });

  if (map.getSource('fac')) map.getSource('fac').setData(facFiltered);
}

/* ---------------- Map layers ---------------- */
function addFacilityLayer(){
  if(map.getSource('fac')){ map.getSource('fac').setData(facFiltered); return; }
  map.addSource('fac',{type:'geojson',data:facFiltered});
  map.addLayer({id:'fac',
    type:'circle',source:'fac',
    paint:{'circle-radius':6,'circle-color':'#3b82f6','circle-stroke-width':1,'circle-stroke-color':'#fff'}});
  map.on('click','fac', async (e)=>{
    const f = e.features[0];
    const id = f.properties.id;
    hazFeature=null; hazBuffer=null; highlightNone();

        if (!f.properties._enriched) {
      q('summary').innerHTML = `<b>${fmt(f.properties.facility_name || f.properties.name)}</b> – loading details...`;
      try {
        const d = await fetchIFRCDetail(id);
        enrichFeatureFromDetail(f, d);

        // update in our collections so we don’t refetch next time
        const upd = (fc)=>{
          const i = fc.features.findIndex(x=>x.properties.id===id);
          if (i>-1) fc.features[i].properties = f.properties;
        };
        upd(facAll); upd(facFiltered);

        if (map.getSource('fac')) map.getSource('fac').setData(facFiltered);
      } catch(err) {
        console.error(err);
      }
    }
    renderFacility(f);
  });
}

/* ---------------- Detail panel ---------------- */
function renderFacility(f){
  const p=f.properties;
  q('summary').innerHTML=`<b>${fmt(p.facility_name || p.name)}</b> (${fmt(p.health_facility_type || p.type_name)}) ${badge(p.status)}`;
  q('list').innerHTML='';

  // pills for services
  const pill = (label, on) => `<span class="pill" style="background:${on?'#e6f4ea':'#f3f4f6'};color:${on?'#166534':'#374151'}">${label}: ${on?'yes':'no'}</span>`;

  q('details').innerHTML=`
    <div class="section"><h3>Core</h3>
      <div class="kv"><b>Type</b> ${fmt(p.health_facility_type || p.type_name)}</div>
      <div class="kv"><b>Status</b> ${badge(p.status)}</div>
      <div class="kv"><b>Country</b> ${fmt(p.country)}</div>
      <div class="kv"><b>Last updated</b> ${fmt(p.last_updated)}</div>
      <div class="kv"><b>Coords</b> ${fmt(p.lat)}, ${fmt(p.lon)}</div>
    </div>

    <div class="section"><h3>Capacity & Activity</h3>
      <div class="kv"><b>Beds total</b> ${fmt(p.beds_total)}</div>
      <div class="kv"><b>Inpatient capable</b> ${t(p.inpatient_capable)?'yes':'no'}</div>
      <div class="kv"><b>Warehousing</b> ${t(p.warehousing)?'yes':'no'}</div>
      <div class="kv"><b>Cold chain</b> ${t(p.cold_chain)?'yes':'no'}</div>
      <div class="kv"><b>Isolation rooms</b> ${fmt(p.isolation_rooms)}</div>
      <div class="kv"><b>Hospital type</b> ${fmt(p.hospital_type)}</div>
      <div class="kv"><b>Teaching hospital</b> ${t(p.teaching_hospital)?'yes':'no'}</div>
    </div>

    <div class="section"><h3>Services</h3>
      ${[
        pill('emergency', p.svc_emergency),
        pill('maternity', p.svc_maternity),
        pill('surgery', p.svc_surgery),
        pill('ncd', p.svc_ncd),
        pill('mhpss', p.svc_mhpss),
        pill('lab', p.svc_lab),
        pill('radiology', p.svc_radiology),
        pill('vaccination', p.svc_vaccination),
        pill('pharmacy', p.svc_pharmacy),
        pill('isolation_id', p.svc_isolation_id)
      ].join(' ')}
    </div>

    <div class="section"><h3>Staff</h3>
      <div class="kv"><b>total hr</b> ${fmt(p.hr_total)}</div>
      <div class="kv"><b>general practitioners</b> ${fmt(p.hr_gp)}</div>
      <div class="kv"><b>specialists</b> ${fmt(p.hr_specialist)}</div>
      <div class="kv"><b>residents doctors</b> ${fmt(p.hr_residents)}</div>
      <div class="kv"><b>nurses</b> ${fmt(p.hr_nurse)}</div>
      <div class="kv"><b>dentists</b> ${fmt(p.hr_dentist)}</div>
      <div class="kv"><b>nursing aids</b> ${fmt(p.hr_nursing_aid)}</div>
      <div class="kv"><b>midwives</b> ${fmt(p.hr_midwife)}</div>
    </div>

    <div class="section"><h3>Needs & Contact</h3>
      <div class="kv"><b>Contact</b> ${fmt(p.contact)}</div>
      <div class="kv"><b>Confidence</b> ${fmt(p.confidence)}</div>
      <div class="kv"><b>Address</b> ${fmt(p.address)}</div>
    </div>`;
}

/* ---------------- Hazards ---------------- */
function highlightNone(){
  if(map.getSource('hazb'))map.getSource('hazb').setData({type:'FeatureCollection',features:[]});
}

function loadUSGS(){
  fetch(USGS).then(r=>r.json()).then(j=>{
    usgsFC=j;
    map.addSource('usgs',{type:'geojson',data:usgsFC});
    map.addLayer({id:'usgs',
      type:'circle',source:'usgs',
      paint:{'circle-radius':8,'circle-color':'#e36a6a','circle-stroke-width':1,'circle-stroke-color':'#fff'}});
    map.on('click','usgs',e=>{
      hazFeature=e.features[0];hazBuffer=null;selectedEQ();
    });
  }).catch(console.error);
}

function selectedEQ(){
  const m=hazFeature.properties.mag, r=magToKm(m);
  hazBuffer=turf.buffer(hazFeature,r,{units:'kilometers'});
  q('details').innerHTML = ''; // clear facility panel
  const exposed={type:'FeatureCollection',
    features:facFiltered.features.filter(pt=>turf.booleanPointInPolygon(pt,hazBuffer))};
  if(!map.getSource('hazb')){
    map.addSource('hazb',{type:'geojson',data:hazBuffer});
    map.addLayer({id:'hazb',type:'fill',source:'hazb',
      paint:{'fill-color':'#e36a6a','fill-opacity':0.1}});
  }else map.getSource('hazb').setData(hazBuffer);

  const counts=exposed.features.reduce((o,f)=>{const s=f.properties.status||'unknown';o[s]=(o[s]||0)+1;return o;},{}),
        statusLine=Object.entries(counts).map(([k,v])=>`${k}:${v}`).join('  ');
  q('summary').innerHTML=`<b>EQ M${m}</b> – ${hazFeature.properties.place||''}<br>
    Radius ~${r} km • <b>${exposed.features.length}</b> exposed facilities<br>${statusLine}
    <div style="margin-top:6px"><button class="btn" id="clr">Clear</button></div>`;
  q('clr').onclick=()=>{hazFeature=null;highlightNone();q('summary').textContent='Tip: click a facility for details or an earthquake for exposure.';q('list').innerHTML='';q('details').innerHTML='';};

  q('list').innerHTML = exposed.features.length
      ? exposed.features.map(f=>{
          const p=f.properties;
          const d=distKm(hazFeature,f).toFixed(1);
          return `<div class="item" data-id="${p.id}">
                    <div><b>${fmt(p.facility_name || p.name)}</b> (${fmt(p.health_facility_type || p.type_name)}) ${badge(p.status)}</div>
                    <div class="small muted">${fmt(p.country)} • ${d} km from epicenter</div>
                  </div>`;
        }).join('')
      : '<div class="item muted">No exposed facilities.</div>';

  Array.from(document.querySelectorAll('.item[data-id]')).forEach(el=>{
      el.onclick=()=>{
        const id=Number(el.getAttribute('data-id'));
        const f=facFiltered.features.find(x=>x.properties.id===id);
        if(f)renderFacility(f);
      };
  });
}

function loadGDACS(){
  fetch(GDACS).then(r=>r.json()).then(j=>{
    if(!j?.features)return;
    gdacsFC=j;
    map.addSource('gdacs',{type:'geojson',data:gdacsFC});
    map.addLayer({id:'gdacs',
      type:'circle',source:'gdacs',
      paint:{'circle-radius':8,'circle-color':'#f4a742','circle-stroke-width':1,'circle-stroke-color':'#fff'}});
  }).catch(()=>console.log('GDACS feed blocked (CORS) – continuing without it'));
}

/* ---------------- UI wiring ---------------- */
['countryFilter','typeFilter','statusFilter','bedsMin'].forEach(id=>q(id).oninput=()=>{applyFilters();highlightNone();});
terrainToggle.onchange=()=>{ terrainToggle.checked ? enableTerrain() : disableTerrain(); };
facToggle.onchange   =()=> { if(map.getLayer('fac')) map.setLayoutProperty('fac','visibility',facToggle.checked?'visible':'none'); };
usgsToggle.onchange  =()=> { if(map.getLayer('usgs')) map.setLayoutProperty('usgs','visibility',usgsToggle.checked?'visible':'none'); };
gdacsToggle.onchange =()=> { if(map.getLayer('gdacs')) map.setLayoutProperty('gdacs','visibility',gdacsToggle.checked?'visible':'none'); };
roadsToggle.onchange =()=> { if(map.getLayer('roads')) map.setLayoutProperty('roads','visibility',roadsToggle.checked?'visible':'none'); };
popToggle.onchange   =()=> { if(map.getLayer('worldcover')) map.setLayoutProperty('worldcover','visibility',popToggle.checked?'visible':'none'); };
satToggle.onchange   =()=> { if(map.getLayer('satellite')) map.setLayoutProperty('satellite','visibility',satToggle.checked?'visible':'none'); };

/* ---------------- Terrain toggle ---------------- */
function enableTerrain(){
  if(!map.getSource('dem')){
    map.addSource('dem',{type:'raster-dem',url:'mapbox://mapbox.terrain-rgb',tileSize:512,maxzoom:14});
    map.setTerrain({source:'dem',exaggeration:1.3});
    map.addLayer({id:'hillshade',type:'hillshade',source:'dem',layout:{visibility:'visible'}});
  }else{
    map.setTerrain({source:'dem',exaggeration:1.3});
    map.setLayoutProperty('hillshade','visibility','visible');
  }
}
function disableTerrain(){
  map.setTerrain(null);
  if(map.getLayer('hillshade')) map.setLayoutProperty('hillshade','visibility','none');
}

/* ---------------- Kick-off ---------------- */
map.on('load',()=>{
  enableTerrain();

  // Facilities + hazards
  loadFacilities();
  loadUSGS();
  loadGDACS();

  // Mapbox Streets for roads
  if (!map.getSource('mapbox-streets')) {
    map.addSource('mapbox-streets', { type: 'vector', url: 'mapbox://mapbox.mapbox-streets-v8' });
  }
  map.addLayer({
    id: 'roads',
    type: 'line',
    source: 'mapbox-streets',
    'source-layer': 'road',
    layout: { visibility:'visible' },
    paint: { 'line-color': '#555', 'line-width': 1 }
  });

  // ESA WorldCover raster (population/land cover stand-in)
  // 2021 layer; change to WORLDCOVER_2022_MAP if desired
  map.addSource('worldcover', {
    type: 'raster',
    tiles: [
      'https://services.terrascope.be/wmts/v2?service=WMTS&request=GetTile&version=1.0.0&layer=WORLDCOVER_2021_MAP&style=default&format=image/png&tilematrixset=GoogleMapsCompatible&TileMatrix={z}&TileCol={x}&TileRow={y}'
    ],
    tileSize: 256
  });
  map.addLayer({
    id: 'worldcover',
    type: 'raster',
    source: 'worldcover',
    layout: { visibility: 'visible' },
    paint: { 'raster-opacity': 0.5 }
  });

  // Satellite imagery
  map.addSource('satellite', { type: 'raster', url: 'mapbox://mapbox.satellite', tileSize: 256 });
  map.addLayer({ id: 'satellite', type: 'raster', source: 'satellite', layout: { visibility: 'none' } });
});
</script>
</body>
</html>
