<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>IFRC Health Facility Exposure (MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <!-- Mapbox -->
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link   href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet"/>
  <!-- Turf for spatial math -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
  <!-- PapaParse for CSV → JSON -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html, body {
    margin: 0;
    height: 100%;
    }

    #map {
    position: absolute;   /* <-- add this */
    top: 0;
    bottom: 0;
    width: 100%;
    }
    #panel{position:absolute;top:10px;left:10px;z-index:2;
      background:rgba(255,255,255,.97);padding:12px;width:380px;
      font-family:system-ui,Arial,sans-serif;font-size:13px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);max-height:calc(100% - 20px);overflow:auto}
    h1{font-size:16px;margin:0 0 6px}
    .legend{font-size:12px;margin:6px 0 8px}
    .legend span{display:inline-block;width:10px;height:10px;margin-right:4px;vertical-align:middle}
    .lg-eq{background:#e36a6a}.lg-gdacs{background:#f4a742}.lg-fac{background:#3b82f6}
    .row{margin:8px 0}
    label{font-weight:600;display:block;margin-bottom:4px}
    select,input[type=number]{width:100%;padding:6px;border:1px solid #ccc;border-radius:4px}
    .toggles{display:flex;gap:10px;flex-wrap:wrap}
    .toggle{display:flex;align-items:center;gap:6px;margin:3px 0}
    .hr{height:1px;background:#eee;margin:10px 0}
    #summary{padding:8px;background:#f6f7f9;border-radius:6px}
    #list{margin-top:8px;max-height:220px;overflow:auto;border:1px solid #eee;border-radius:6px}
    .item{padding:8px;border-bottom:1px solid #eee;cursor:pointer}
    .item:last-child{border-bottom:none}
    .muted{color:#666}
    .badge{display:inline-block;padding:2px 6px;border-radius:10px;font-size:11px;margin-left:6px}
    .status-functional{background:#e7f6ec;color:#1b7f3a}
    .status-partial{background:#fff7e6;color:#ad5a00}
    .status-nonfunctional{background:#fdecec;color:#9a1f1f}
    .status-unknown{background:#eef2f7;color:#374151}
    .kv{margin:3px 0}.kv b{display:inline-block;min-width:150px}
    .section{margin-top:10px}
    .section h3{font-size:13px;margin:8px 0 4px;border-bottom:1px solid #eee;padding-bottom:3px}
    .small{font-size:12px}
    .pill{display:inline-block;background:#eef;border-radius:9999px;padding:2px 8px;margin:2px;font-size:11px}
    .btn{background:#2563eb;color:#fff;border:none;border-radius:4px;padding:6px 8px;cursor:pointer}
  </style>
</head>
<body>
<div id="map"></div>

<div id="panel">
  <h1>IFRC Health Facility Exposure (MVP)</h1>
  <div class="legend">
    <span class="lg-eq"></span>USGS Earthquakes
    <span class="lg-gdacs" style="margin-left:10px"></span>GDACS (beta)
    <span class="lg-fac" style="margin-left:10px"></span>IFRC Facilities
  </div>

  <div class="row">
    <label>Filters</label>
    <select id="countryFilter"><option value="">All countries</option></select>
    <div style="height:6px"></div>
    <select id="typeFilter">
      <option value="">All types</option><option>clinic</option><option>field_hospital</option><option>mobile_clinic</option><option>polyclinic</option>
    </select>
    <div style="height:6px"></div>
    <select id="statusFilter">
      <option value="">All status</option><option>functional</option><option>partial</option><option>nonfunctional</option><option>unknown</option>
    </select>
    <div style="height:6px"></div>
    <input id="bedsMin" type="number" min="0" placeholder="Min total beds (optional)">
  </div>

  <div class="row toggles">
    <div class="toggle"><input type="checkbox" id="terrainToggle" checked><label>Terrain</label></div>
    <div class="toggle"><input type="checkbox" id="facToggle" checked><label>Facilities</label></div>
    <div class="toggle"><input type="checkbox" id="usgsToggle" checked><label>USGS EQ</label></div>
    <div class="toggle"><input type="checkbox" id="gdacsToggle" checked><label>GDACS</label></div>
    <div class="toggle"><input type="checkbox" id="roadsToggle" checked><label>Roads</label></div>
    <div class="toggle"><input type="checkbox" id="popToggle" checked><label>Population</label></div>
  </div>

  <div class="hr"></div>

  <div id="summary" class="small">Tip: click a facility for details or an earthquake for exposure.</div>
  <div id="list"></div>
  <div id="details" class="section"></div>
</div>

<script>
mapboxgl.accessToken='pk.eyJ1Ijoic2FtaWtzaGFnYWhlcndhciIsImEiOiJjbWVnOHVjamcxNHFwMm5xNHJscHdxYjdqIn0.x2xdpJyWndbT007njbAKEA';         // ← replace once
const FAC_CSV='facilities_dataset.csv';
const USGS='https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/4.5_day.geojson';
const GDACS='https://cors-anywhere.herokuapp.com/https://www.gdacs.org/gdacsapi/api/events/geteventlist/';  // proxy

let facAll={type:'FeatureCollection',features:[]}, facFiltered={type:'FeatureCollection',features:[]};
let usgsFC=null, gdacsFC=null, hazFeature=null, hazBuffer=null;

const map=new mapboxgl.Map({container:'map',style:'mapbox://styles/mapbox/light-v11',center:[20,10],zoom:2});

const q=(id)=>document.getElementById(id);
const fmt=(v)=>v||v===0?v:'—';
const n=(v)=>Number(v);
const t=(v)=>String(v).toLowerCase()==='true';
const badge=(s)=>`<span class="badge status-${s||'unknown'}">${s||'unknown'}</span>`;
const magToKm=(m)=>Math.max(10,Math.min(Math.round(Math.pow(10,0.5*m-1.2)),250));
const distKm=(a,b)=>turf.distance(a,b,{units:'kilometers'});

function csvToGeo(json){
  return {type:'FeatureCollection',features:json.map(r=>{
      const f={type:'Feature',geometry:{type:'Point',coordinates:[n(r.lon),n(r.lat)]},properties:r};
      return f;
  })};
}

function loadFacilities(){
  Papa.parse(FAC_CSV,{download:true,header:true,dynamicTyping:true,
    complete:res=>{
      facAll=csvToGeo(res.data.filter(r=>r.id));
      populateCountryFilter();
      applyFilters();
      addFacilityLayer();
    }});
}

function populateCountryFilter(){
  const set=new Set(facAll.features.map(f=>f.properties.country).filter(Boolean));
  q('countryFilter').innerHTML='<option value="">All countries</option>'+
    [...set].sort().map(c=>`<option>${c}</option>`).join('');
}

function applyFilters(){
  const c=q('countryFilter').value,t=q('typeFilter').value,s=q('statusFilter').value, bmin=n(q('bedsMin').value)||0;
  facFiltered.features=facAll.features.filter(f=>{
    const p=f.properties;
    return (!c||p.country===c)&&(!t||p.type===t)&&(!s||p.status===s)&&(!bmin||p.beds_total>=bmin);
  });
  if(map.getSource('fac'))map.getSource('fac').setData(facFiltered);
}

function addFacilityLayer(){
  if(map.getSource('fac')){map.getSource('fac').setData(facFiltered);return;}
  map.addSource('fac',{type:'geojson',data:facFiltered});
  map.addLayer({id:'fac',
    type:'circle',source:'fac',
    paint:{'circle-radius':6,'circle-color':'#3b82f6','circle-stroke-width':1,'circle-stroke-color':'#fff'}});
  map.on('click','fac',e=>{
    const f=e.features[0];hazFeature=null;hazBuffer=null;renderFacility(f);highlightNone();
  });
}

function renderFacility(f){
  const p=f.properties;
  q('summary').innerHTML=`<b>${fmt(p.name)}</b> (${fmt(p.type)}) ${badge(p.status)}`;
  q('list').innerHTML='';
  q('details').innerHTML=`
    <div class="section"><h3>Core</h3>
      <div class="kv"><b>Type</b> ${fmt(p.type)}</div>
      <div class="kv"><b>Status</b> ${badge(p.status)}</div>
      <div class="kv"><b>Country</b> ${fmt(p.country)}</div>
      <div class="kv"><b>Owner</b> ${fmt(p.owner)}</div>
      <div class="kv"><b>Last updated</b> ${fmt(p.last_updated)}</div>
      <div class="kv"><b>Coords</b> ${p.lat}, ${p.lon}</div>
    </div>
    <div class="section"><h3>Capacity & Activity</h3>
      <div class="kv"><b>Beds total/avail</b> ${fmt(p.beds_total)} / ${fmt(p.beds_available)}</div>
      <div class="kv"><b>OPD daily avg</b> ${fmt(p.opd_daily_avg)}</div>
      <div class="kv"><b>Inpatient capable</b> ${t(p.inpatient_capable)?'yes':'no'}</div>
    </div>
    <div class="section"><h3>Services</h3>
      ${['svc_emergency','svc_maternity','svc_surgery','svc_ncd','svc_mhpss','svc_lab','svc_radiology','svc_vaccination','svc_pharmacy','svc_isolation_id']
        .filter(k=>k in p)
        .map(k=>`<span class="pill" style="background:${t(p[k])?'#e6f4ea':'#f3f4f6'};color:${t(p[k])?'#166534':'#374151'}">${k.replace('svc_','')}: ${t(p[k])?'yes':'no'}</span>`).join(' ')
      ||'<span class="muted">no data</span>'}
    </div>
    <div class="section"><h3>Needs & Contact</h3>
      <div class="kv"><b>Needs</b> ${fmt(p.needs_priority)}</div>
      <div class="kv"><b>Contact</b> ${fmt(p.contact)}</div>
      <div class="kv"><b>Confidence</b> ${fmt(p.confidence)}</div>
    </div>`;
}

function highlightNone(){
  if(map.getSource('hazb'))map.getSource('hazb').setData({type:'FeatureCollection',features:[]});
}

function loadUSGS(){
  fetch(USGS).then(r=>r.json()).then(j=>{
    usgsFC=j;
    map.addSource('usgs',{type:'geojson',data:usgsFC});
    map.addLayer({id:'usgs',
      type:'circle',source:'usgs',
      paint:{'circle-radius':8,'circle-color':'#e36a6a','circle-stroke-width':1,'circle-stroke-color':'#fff'}});
    map.on('click','usgs',e=>{
      hazFeature=e.features[0];hazBuffer=null;selectedEQ();
    });
  }).catch(console.error);
}

function selectedEQ(){
  const m=hazFeature.properties.mag, r=magToKm(m);
  hazBuffer=turf.buffer(hazFeature,r,{units:'kilometers'});
  q('details').innerHTML = '';   // Clear facility detail panel when EQ is clicked
  const exposed={type:'FeatureCollection',
    features:facFiltered.features.filter(pt=>turf.booleanPointInPolygon(pt,hazBuffer))};
  if(!map.getSource('hazb')){
    map.addSource('hazb',{type:'geojson',data:hazBuffer});
    map.addLayer({id:'hazb',type:'fill',source:'hazb',
      paint:{'fill-color':'#e36a6a','fill-opacity':0.1}});
  }else map.getSource('hazb').setData(hazBuffer);

  // summary
  const counts=exposed.features.reduce((o,f)=>{const s=f.properties.status||'unknown';o[s]=(o[s]||0)+1;return o;},{}),
        statusLine=Object.entries(counts).map(([k,v])=>`${k}:${v}`).join('  ');
  q('summary').innerHTML=`<b>EQ M${m}</b> – ${hazFeature.properties.place||''}<br>
    Radius ~${r} km • <b>${exposed.features.length}</b> exposed facilities<br>${statusLine}
    <div style="margin-top:6px"><button class="btn" id="clr">Clear</button></div>`;
  q('clr').onclick=()=>{hazFeature=null;highlightNone();q('summary').textContent='Tip: click a facility for details or an earthquake for exposure.';q('list').innerHTML='';q('details').innerHTML='';};

  // list exposed
  q('list').innerHTML = exposed.features.length
      ? exposed.features.map(f=>{
          const p=f.properties;
          const d=distKm(hazFeature,f).toFixed(1);
          return `<div class="item" data-id="${p.id}">
                    <div><b>${p.name}</b> (${p.type}) ${badge(p.status)}</div>
                    <div class="small muted">${p.country} • ${d} km from epicenter</div>
                  </div>`;
        }).join('')
      : '<div class="item muted">No exposed facilities.</div>';

  // click an exposed item → show its details
  Array.from(document.querySelectorAll('.item[data-id]')).forEach(el=>{
      el.onclick=()=>{
        const id=el.getAttribute('data-id');
        const f=facFiltered.features.find(x=>x.properties.id===id);
        if(f)renderFacility(f);
      };
  });
}

function loadGDACS(){
  fetch(GDACS).then(r=>r.json()).then(j=>{
    if(!j?.features)return;
    gdacsFC=j;
    map.addSource('gdacs',{type:'geojson',data:gdacsFC});
    map.addLayer({id:'gdacs',
      type:'circle',source:'gdacs',
      paint:{'circle-radius':8,'circle-color':'#f4a742','circle-stroke-width':1,'circle-stroke-color':'#fff'}});
  }).catch(()=>console.log('GDACS feed blocked (CORS) – continuing without it'));
}

/* ------------- UI wiring ------------- */
['countryFilter','typeFilter','statusFilter','bedsMin'].forEach(id=>q(id).oninput=()=>{applyFilters();highlightNone();});
terrainToggle.onchange=()=>{ terrainToggle.checked ? enableTerrain() : disableTerrain(); };
facToggle.onchange   =()=> map.setLayoutProperty('fac','visibility',facToggle.checked?'visible':'none');
usgsToggle.onchange  =()=> map.setLayoutProperty('usgs','visibility',usgsToggle.checked?'visible':'none');
gdacsToggle.onchange =()=> map.setLayoutProperty('gdacs','visibility',gdacsToggle.checked?'visible':'none');
roadsToggle.onchange =()=> map.setLayoutProperty('roads','visibility',roadsToggle.checked?'visible':'none');
popToggle.onchange   =()=> map.setLayoutProperty('pop','visibility',popToggle.checked?'visible':'none');

/* ------------- Terrain toggle ------------- */
function enableTerrain(){
  if(!map.getSource('dem')){
    map.addSource('dem',{type:'raster-dem',url:'mapbox://mapbox.terrain-rgb',tileSize:512,maxzoom:14});
    map.setTerrain({source:'dem',exaggeration:1.3});
    map.addLayer({id:'hillshade',type:'hillshade',source:'dem',layout:{visibility:'visible'}});
  }else{
    map.setTerrain({source:'dem',exaggeration:1.3});
    map.setLayoutProperty('hillshade','visibility','visible');
  }
}
function disableTerrain(){
  map.setTerrain(null);
  if(map.getLayer('hillshade')) map.setLayoutProperty('hillshade','visibility','none');
}

/* ------------- Kick-off ------------- */
map.on('load',()=>{
  enableTerrain();
  loadFacilities();
  loadUSGS();
  loadGDACS();
// Add Mapbox Streets source if not already included by style
if (!map.getSource('mapbox-streets')) {
  map.addSource('mapbox-streets', {
    type: 'vector',
    url: 'mapbox://mapbox.mapbox-streets-v8'
  });
}

map.addLayer({
  'id': 'roads',
  'type': 'line',
  'source': 'mapbox-streets',
  'source-layer': 'road',
  'layout': {'visibility':'visible'},
  'paint': {
    'line-color': '#555',
    'line-width': 1
  }
});
map.addSource('worldpop', {
  'type': 'raster',
  'tiles': [
    'https://tiles.arcgis.com/tiles/DO4gTjwJVIJ7O9Ca/arcgis/rest/services/GHS_POP_2015/MapServer/tile/{z}/{y}/{x}'
  ],
  'tileSize': 256
});

map.addLayer({
  'id': 'worldpop',
  'type': 'raster',
  'source': 'worldpop',
  'layout': {'visibility': 'visible'},
  'paint': {'raster-opacity': 0.5}
});

});
</script>
</body>
</html>
